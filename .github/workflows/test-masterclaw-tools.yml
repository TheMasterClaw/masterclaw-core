name: Test MasterClaw Tools

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'masterclaw-tools/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'masterclaw-tools/**'

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    strategy:
      matrix:
        node-version: ['18.x', '20.x', '22.x']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: masterclaw-tools/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run security tests
      run: npm test
      timeout-minutes: 5

    - name: Check for security vulnerabilities
      run: npm audit --audit-level=moderate
      continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: masterclaw-tools/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint || true

  security-scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Run security-focused tests
      run: |
        echo "=== Running Services Security Tests ==="
        node --test tests/services.security.test.js
        echo ""
        echo "=== Running Docker Security Tests ==="
        node --test tests/docker.security.test.js
        echo ""
        echo "=== Running Exec Security Tests ==="
        node --test tests/exec.security.test.js
        echo ""
        echo "=== Running Audit Integrity Tests ==="
        node --test tests/audit.integrity.test.js
        echo ""
        echo "=== Running HTTP Client Security Tests ==="
        node --test tests/http-client.test.js
        echo ""
        echo "=== Running Chat Security Tests ==="
        node --test tests/chat-security.test.js
        echo ""
        echo "=== Running Import Security Tests ==="
        node --test tests/import.security.test.js
      timeout-minutes: 10

    - name: Verify security module exports
      run: |
        node -e "
          const security = require('./lib/security.js');
          console.log('✅ Security module loaded successfully');
          console.log('Exported functions:', Object.keys(security));
          
          // Verify key security functions exist
          const required = ['sanitizeForLog', 'maskSensitiveData', 'secureLogString', 'isSafeString', 'isValidIpAddress', 'isValidHostname', 'containsPathTraversal', 'sanitizeFilename', 'constantTimeCompare', 'safeJsonParse', 'safeJsonStringify'];
          let missing = [];
          for (const fn of required) {
            if (typeof security[fn] !== 'function') {
              console.error('❌ Missing required function:', fn);
              missing.push(fn);
            } else {
              console.log('✅', fn, 'is exported');
            }
          }
          if (missing.length > 0) {
            console.error('❌ Missing functions:', missing.join(', '));
            process.exit(1);
          }
          console.log('✅ All security functions verified');
        "

    - name: Test audit logging functionality
      run: |
        node -e "
          const audit = require('./lib/audit.js');
          console.log('✅ Audit module loaded successfully');
          console.log('Exported functions:', Object.keys(audit));
          console.log('AuditEventTypes:', Object.keys(audit.AuditEventType || {}));
          console.log('✅ Audit module verified');
        "

    - name: Test error handler functionality
      run: |
        node -e "
          const errorHandler = require('./lib/error-handler.js');
          console.log('✅ Error handler module loaded successfully');
          console.log('Exported functions:', Object.keys(errorHandler));
          
          // Verify key error handling functions exist
          const required = ['wrapCommand', 'setupGlobalErrorHandlers', 'displayError', 'classifyError', 'getUserMessage', 'getSuggestion', 'auditLogError'];
          let missing = [];
          for (const fn of required) {
            if (typeof errorHandler[fn] !== 'function') {
              console.error('❌ Missing required function:', fn);
              missing.push(fn);
            } else {
              console.log('✅', fn, 'is exported');
            }
          }
          if (missing.length > 0) {
            console.error('❌ Missing functions:', missing.join(', '));
            process.exit(1);
          }
          
          // Verify constants are exported
          if (!errorHandler.ExitCode || !errorHandler.ErrorCategory) {
            console.error('❌ Missing ExitCode or ErrorCategory constants');
            process.exit(1);
          }
          console.log('✅ ExitCode constants:', Object.keys(errorHandler.ExitCode));
          console.log('✅ ErrorCategory constants:', Object.keys(errorHandler.ErrorCategory));
          console.log('✅ Error handler module verified');
        "

    - name: Test correlation ID functionality
      run: |
        node -e "
          const correlation = require('./lib/correlation.js');
          console.log('✅ Correlation module loaded successfully');
          console.log('Exported functions:', Object.keys(correlation));
          
          // Test correlation ID generation
          const id1 = correlation.generateCorrelationId();
          const id2 = correlation.generateCorrelationId();
          console.log('Generated correlation IDs:', id1, id2);
          
          if (id1 === id2) {
            console.error('❌ Correlation IDs should be unique');
            process.exit(1);
          }
          
          // Test validation
          const validation = correlation.validateCorrelationId(id1);
          if (!validation.valid) {
            console.error('❌ Generated ID should be valid:', validation.error);
            process.exit(1);
          }
          console.log('✅ Correlation ID functionality verified');
        "
