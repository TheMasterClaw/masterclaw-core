name: Test MasterClaw Tools

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'masterclaw-tools/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'masterclaw-tools/**'

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    strategy:
      matrix:
        node-version: ['18.x', '20.x', '22.x']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: masterclaw-tools/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run security tests
      run: npm test
      timeout-minutes: 5

    - name: Check for security vulnerabilities
      run: npm audit --audit-level=moderate
      continue-on-error: true

  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: masterclaw-tools/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint || true

  security-scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./masterclaw-tools

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Run security-focused tests
      run: |
        echo "=== Running Path Security Tests ==="
        node --test tests/path-security.test.js
        echo ""
        echo "=== Running SSL Security Tests ==="
        node --test tests/ssl-security.test.js
        echo ""
        echo "=== Running Audit Security Tests ==="
        node --test tests/audit-security.test.js
        echo ""
        echo "=== Running HTTP Client Security Tests ==="
        node --test tests/http-client.test.js
      timeout-minutes: 5

    - name: Verify security module exports
      run: |
        node -e "
          const security = require('./lib/security.js');
          console.log('✅ Security module loaded successfully');
          console.log('Exported functions:', Object.keys(security));
          
          // Verify key security functions exist
          const required = ['validatePath', 'validateInfraDir', 'validateFileName', 'sanitizePathForDisplay'];
          for (const fn of required) {
            if (typeof security[fn] !== 'function') {
              console.error('❌ Missing required function:', fn);
              process.exit(1);
            }
            console.log('✅', fn, 'is exported');
          }
          console.log('✅ All security functions verified');
        "

    - name: Test audit logging functionality
      run: |
        node -e "
          const audit = require('./lib/audit.js');
          console.log('✅ Audit module loaded successfully');
          console.log('Exported functions:', Object.keys(audit));
          console.log('AuditEventTypes:', Object.keys(audit.AuditEventType || {}));
          console.log('✅ Audit module verified');
        "
