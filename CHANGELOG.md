# Changelog

All notable changes to MasterClaw Core will be documented in this file.

## [Unreleased]

### Added
- **Alias Management Command** (`masterclaw-tools/lib/alias.js`)
  - New `mc alias` command for managing CLI aliases and shortcuts
  - **Command aliases**: Short aliases for frequently used commands (e.g., `s` → `status`, `l` → `logs`)
  - **Shell shortcuts**: Full shell commands for complex workflows
  - **Subcommands**:
    - `mc alias list` - Show all aliases and shortcuts (with `--json` option)
    - `mc alias run <name>` - Execute an alias or shortcut
    - `mc alias add <name> <command>` - Add new command alias
    - `mc alias add <name> <command> --shortcut` - Add shell shortcut
    - `mc alias show <name>` - Display alias details
    - `mc alias remove <name>` - Delete an alias
    - `mc alias export [file]` - Export aliases to JSON
    - `mc alias import <file>` - Import aliases (with `--merge` option)
    - `mc alias reset --force` - Reset to defaults
  - **Default aliases**: 17 pre-configured aliases (s, st, l, log, b, bk, r, u, d, cfg, ex, ev, nt, perf, sm, val)
  - **Default shortcuts**: 7 pre-configured shortcuts (deploy, logs-backend, logs-core, logs-gateway, quick-status, full-backup, health-watch)
  - **Security features**: Rate limiting on all operations, input validation for alias names
  - **Integration**: Stores aliases in rex-deus config (`~/.openclaw/workspace/rex-deus/config/aliases.json`)
  - Version bump to 0.27.0

### Security Hardening & Reliability Improvements
- **Test Framework Standardization** (`masterclaw-tools/tests/http-client.test.js`)
  - Converted test file from `node:test` to Jest framework for consistency
  - Fixed failing test by properly importing SERVICES from services module
  - Standardized test syntax with Jest matchers (toBe, toHaveLength, etc.)
  - Improved test organization with clear describe blocks
  - All 20 tests now pass successfully
- **Memory ID Generation Security** (`masterclaw_core/memory.py`)
  - **Replaced MD5 with SHA-256** for memory ID generation in both backends
    - MD5 is cryptographically broken and vulnerable to collision attacks
    - SHA-256 provides 256-bit security vs MD5's broken 128-bit (effectively 64-bit) security
    - IDs remain 32 hex characters for backward compatibility (truncated SHA-256)
    - Updated `ChromaBackend.add()` and `JSONBackend.add()` methods
    - No breaking changes - existing IDs remain valid, new IDs use stronger algorithm
- **Performance Module Security Enhancements** (`lib/performance.js`)
  - **Input validation** for all numeric parameters (`n`, `limit`) with DoS protection
    - Bounds checking prevents excessive values (max 100 endpoints, 1000 profiles)
    - Safe integer validation prevents integer overflow attacks
    - Type coercion with validation for string inputs
  - **Correlation ID integration** for distributed tracing across API calls
    - Automatic propagation via `x-correlation-id` HTTP header
    - Enables end-to-end request tracing through the Core API
  - **Exponential backoff retry logic** for resilient API communication
    - 3 retries with configurable initial delay (500ms) and max delay (5s)
    - Jitter (±25%) prevents thundering herd on service recovery
    - Only retries transient errors (network, 502/503/504/429 status codes)
  - **Response size limiting** (1MB max) prevents memory exhaustion attacks
  - **Timeout hardening** with configurable bounds (1s min, 60s max)
  - **Sensitive data masking** in all error messages
  - **Comprehensive test coverage** - 56 test cases covering security, validation, retries, and error handling

### Added
- **API Performance Profiling** - Comprehensive endpoint performance monitoring and analysis
  - New `PerformanceProfilingMiddleware` tracks request duration per endpoint
  - Configurable slow request threshold (default: 1000ms) via `PERF_SLOW_THRESHOLD_MS`
  - Memory-efficient profile storage with configurable limit (default: 10,000 profiles)
  - NEW API Endpoints:
    - `GET /v1/performance/profiles` — View recent request profiles with optional slow-only filter
    - `GET /v1/performance/stats` — Aggregated endpoint statistics (count, avg/min/max times, slow%)
    - `GET /v1/performance/slowest` — Top N slowest endpoints by average response time
    - `GET /v1/performance/summary` — Quick performance overview
    - `DELETE /v1/performance/profiles` — Clear all profiles (auth required)
  - NEW CLI Commands (`mc performance`):
    - `mc performance` — Show performance summary (default)
    - `mc performance --stats` — Detailed endpoint statistics table
    - `mc performance --slowest [n]` — Show top N slowest endpoints
    - `mc performance --profiles [n]` — Show recent request profiles
    - `mc performance --profiles --slow-only` — Only show slow requests
    - `mc performance --clear` — Clear all performance profiles
  - Features:
    - Color-coded response times (green < 500ms, yellow < 1000ms, red > 1000ms)
    - Automatic logging of slow requests with warnings
    - Groups profiles by endpoint for better readability
    - Pydantic models for type-safe responses
    - OpenAPI documentation in Swagger UI and ReDoc
  - Files: `lib/performance.js` (CLI), updated `middleware.py`, `models.py`, `main.py`

- **Secrets Management Module (`mc secrets`)** - Secure, centralized secrets management for the MasterClaw ecosystem
  - `mc secrets check` — Validate all required secrets are configured across CLI and .env
  - `mc secrets list` — Display configured secrets with masking (never shows full values)
  - `mc secrets set <key> <value>` — Securely store secrets with format validation
  - `mc secrets get <key>` — Retrieve secret metadata with masked value
  - `mc secrets delete <key>` — Remove secrets with confirmation
  - `mc secrets rotate <key>` — Generate new tokens or rotate API keys
  - `mc secrets validate <key>` — Test secrets against their services (OpenAI, Anthropic, Gateway)
  - `mc secrets sync` — Synchronize secrets between CLI storage and .env file
  - `mc secrets export` — Export secrets (masked) for backup or documentation
  - Security: File permissions 0o600, masked display by default, audit logging without values
  - Validation: Enforces API key formats (OpenAI: `sk-...`, Anthropic: `sk-ant-...`)
  - Token generation: Cryptographically secure random token generation for GATEWAY_TOKEN
  - Required secrets tracking: GATEWAY_TOKEN (required), OPENAI_API_KEY, ANTHROPIC_API_KEY (optional)
  - New `lib/secrets.js` module with comprehensive test suite (`tests/secrets.test.js`)
- **Correlation ID System** - Distributed tracing for CLI operations
  - Unique correlation IDs generated for each command execution
  - IDs propagated through logger, audit log, and event systems
  - Environment variable `MC_CORRELATION_ID` for CI/CD integration
  - HTTP header `x-correlation-id` support for API calls
  - Child correlation IDs for sub-operations (hierarchical tracing)
  - Security: IDs validated and sanitized to prevent injection
  - New `lib/correlation.js` module with 66 comprehensive tests
  - `wrapCommandWithCorrelation()` for automatic command tracing
  - Enables end-to-end tracing of operations across log types
- **Event Tracking System (`mc events`)** - Centralized event tracking and notification history
  - `mc events list` — List events with filtering by type, severity, source, and time
  - `mc events show <id>` — Display detailed event information
  - `mc events ack <id>` — Acknowledge individual events
  - `mc events ack-all` — Bulk acknowledge events
  - `mc events stats` — Event statistics and summaries
  - `mc events add <title>` — Add custom events
  - `mc events export` — Export events to JSON or CSV
  - `mc events watch` — Real-time event monitoring
  - Event types: backup, deploy, alert, error, warning, info, security, maintenance, restore, update
  - Severity levels: critical, high, medium, low, info
  - Automatic event creation from other commands (backup, deploy, restore)
- **Error Handler JSON Output Mode** - Structured JSON error output for production/CI environments
  - Set `MC_JSON_OUTPUT=1` to enable machine-readable error output
  - Structured JSON schema with timestamp, category, exit code, message, and error details
  - Sensitive data automatically masked in JSON output
  - Useful for log aggregation (ELK, Splunk, cloud logging) and CI/CD pipelines
  - Global error handlers (unhandled rejections, uncaught exceptions) also support JSON mode
- **Chat Command Security Hardening** - Enhanced security for `mc chat` command
  - Input validation: max length (10,000 chars), line count limits, dangerous pattern detection
  - XSS protection: blocks script tags, event handlers, javascript: URLs, data:text/html
  - Input sanitization: removes control characters, ANSI escapes, suspicious Unicode
  - Rate limiting: 20 messages per minute per user
  - Sensitive data masking for audit logs
  - New `lib/chat-security.js` module with comprehensive security utilities
  - 55 test cases covering validation, sanitization, and risk analysis
- **Config Command Module (`mc config`)** - Complete configuration management for CLI
  - `mc config list` — Display all configuration values with security masking
  - `mc config get <key>` — Retrieve specific values using dot notation
  - `mc config set <key> <value>` — Update configuration with type inference
  - `mc config export [file]` — Export config to JSON with sensitive value masking
  - `mc config import <file>` — Import config with diff preview and dry-run support
  - `mc config reset` — Reset to defaults with confirmation protection
  - Security features: rate limiting, sensitive value masking, prototype pollution protection
- **Security Auto-Responder Path Fallback** - Improved error handling for file system operations
  - Automatic fallback to alternate paths when default paths aren't writable
  - Graceful handling of permission errors with informative logging
  - Path information included in statistics for better observability
  - System continues to function in-memory when persistence fails
  - New tests for permission error scenarios
- **Batch Memory Import/Export API** - Efficient bulk memory operations
  - `POST /v1/memory/batch` - Import up to 1000 memories in a single request
    - Skip duplicate detection based on content hash
    - Source prefix for tracking import origin
    - Detailed import report with success/failure counts
  - `POST /v1/memory/export` - Export memories with flexible filtering
    - Semantic search query filtering
    - Metadata, source, and date range filters
    - Up to 5000 memories per export request
  - New Pydantic models: `BatchMemoryImportRequest`, `BatchMemoryImportResponse`, `MemoryExportRequest`, `MemoryExportResponse`
  - Complements existing single-memory endpoints for migration and backup workflows
- **Tool Use Framework** - Comprehensive tool calling system for AI agents
  - `GET /v1/tools` - List all available tools with their definitions
  - `GET /v1/tools/{tool_name}` - Get detailed information about a specific tool
  - `POST /v1/tools/execute` - Execute a tool with provided parameters
  - `GET /v1/tools/definitions/openai` - Get tools in OpenAI function format
  - **GitHub Tool** - Full GitHub API integration (repos, issues, PRs, comments)
  - **System Tool** - Safe system commands and information (with security restrictions)
  - **Weather Tool** - Weather data via Open-Meteo API (no API key required)
  - Extensible registry for adding custom tools
  - Parameter validation and type checking
  - Security controls for dangerous operations
- **Interactive API Documentation** - Auto-generated docs with Swagger UI and ReDoc
  - Swagger UI at `/docs` - Interactive API explorer with "Try it out" feature
  - ReDoc at `/redoc` - Clean, responsive API reference documentation  
  - OpenAPI 3.0 schema at `/openapi.json` - Machine-readable specification
  - Categorized endpoints with descriptions for better navigation
  - Enhanced root endpoint (`/`) with documentation URLs
- **Analytics API Endpoints** - Expose usage metrics and statistics
  - `GET /v1/analytics` - Analytics system summary and available metrics
  - `GET/POST /v1/analytics/stats` - Usage statistics (requests, chats, tokens, error rates)
  - Automatic tracking of API requests with timing and status codes
  - Chat usage tracking by provider and model
  - Memory search performance metrics
  - Configurable lookback period (1-90 days)
- **WebSocket Streaming Chat Endpoint** (`/v1/chat/stream/{session_id}`)
  - Real-time token-by-token streaming for chat responses
  - Support for both OpenAI and Anthropic providers
  - Integrated memory retrieval for contextual responses
  - Comprehensive error handling with typed error codes
  - Automatic conversation storage to memory
  - Bidirectional JSON message protocol

### Changed
- Updated root endpoint (`/`) to include new WebSocket and Analytics endpoints
- Chat and memory endpoints now track analytics automatically
- Enhanced API metadata with detailed descriptions and authentication info
- **Security**: Improved `security_response.py` with graceful file permission error handling
  - Added `_ensure_writable_path()` method with automatic fallback logic
  - Enhanced `_save_blocklist()` and `_save_rules()` with specific error handling
  - Updated `get_stats()` to include path information for debugging

## [0.1.0] - 2026-02-13

### Added
- Initial release of MasterClaw Core
- REST API with chat completion endpoint (`/v1/chat`)
- Memory management with semantic search
- WebSocket connection manager (infrastructure only)
- Support for OpenAI and Anthropic LLM providers
- Health check endpoint (`/health`)

---

*Format based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)*
